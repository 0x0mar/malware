#!/usr/bin/python

"""
Hacking Team 'core-packer' PoC detector
Copyright (C) 2015 - Jos Wetzels.
See the file 'LICENSE' for copying permission.

Proof-of-Concept detector script for PEs packed with Hacking Team's 'core-packer' (https://github.com/hackedteam/core-packer/)
See http://samvartaka.github.io/malware/2015/09/13/hackingteam-crypter/ for more details.
"""

from collections import defaultdict

# Identical block profiles
iblock_profiles = {}
iblock_profiles['rcs_soldier'] = {'sections': ['.text', '.data'],
								  'iblocks':
								  {'.data': [[7840, 7912, 8056, 8200, 8560, 8632, 8848], [4088, 4120, 4152, 4184, 4264, 4488, 4712, 9456], [4112, 4256, 9448], [7152, 7264, 7336, 7408, 7768, 7984], [7120, 7736, 8528, 8888], [4048, 4056], [8344, 8704], [7024, 7112], [7952, 8024, 8096, 8600, 8816], [6976, 7064], [7008, 7096], [2352, 5392], [5832, 5904, 8128, 8488], [4144, 4176], [8672, 8744], [3192, 3224], [6992, 7080], [0, 4216, 4304, 4736, 9416], [2720, 2728, 2744, 2752, 2768, 2776, 2784, 2800, 2816, 2824, 2832, 2848, 2856, 2864], [7472, 7544], [6968, 7056], [4872, 4880, 4888, 4896, 4904, 4912, 4920, 4928, 4936, 4944, 4952, 4960, 4968, 4976, 4984, 4992, 5000, 5008, 5016, 5024, 5032, 5040, 5048, 5056, 5064, 5072, 5080, 5088, 5096, 5104, 5112, 5120, 5128, 5136, 5144, 5152, 5160, 5168, 5176, 5184, 5192, 5200, 5208, 5216, 5224, 5232, 5240, 5248, 5256, 5264, 5272, 5280, 5288, 5296, 5304, 5312, 5320, 5328, 5336, 5344, 5352, 5360, 5368, 5376], [7000, 7088], [7280, 7352, 7424], [6944, 7032], [8384, 8960, 9104], [5872, 8456], [96, 104, 112], [1632, 1680], [5656, 5728, 5800, 7880], [6984, 7072], [8176, 8248, 8320, 8464], [9184, 9256], [7016, 7104], [128, 3232, 3792, 7344], [8936, 9008], [632, 640, 648, 1152, 1160], [5688, 5760], [2000, 2184, 3136, 3200, 5400, 7272, 7560, 7632, 9480], [600, 608, 616, 1120, 1128], [8120, 8192], [9336, 9352], [48, 56, 64, 72], [8920, 8992, 9064], [24, 504, 512, 520, 528, 536, 544, 552, 560, 568, 576, 584, 656, 664, 672, 680, 688, 696, 704, 712, 720, 728, 736, 744, 752, 760, 768, 776, 784, 792, 800, 808, 816, 824, 832, 840, 912, 920, 928, 936, 944, 952, 960, 968, 976, 984, 992, 1000, 1008, 1016, 1024, 1032, 1040, 1048, 1056, 1064, 1072, 1080, 1088, 1096, 1104, 1176, 1184, 1192, 1200, 1208, 1216, 1224, 1232, 1240, 1248, 1256, 1264, 1272, 1280, 1288, 1296, 1304, 1312, 1320, 1328, 1336, 1344, 1352, 1360, 1368, 1440, 1448, 1456, 1464, 1472, 1480, 1488, 1496, 1504, 1512, 1520, 1528, 1536, 1544, 1552, 1560, 1640, 1648, 1688, 1696, 1736, 1744, 1784, 1792, 2192, 2200, 2208, 2216, 2224, 2232, 2240, 2248, 2256, 2264, 2280, 2296, 2312, 2328, 2344, 2360, 2376, 2536, 2560, 2592, 2600, 2608, 2616, 2624, 2632, 2640, 2656, 2664, 2672, 2680, 2688, 2696, 2704, 2736, 2760, 2792, 2808, 2840, 2872, 2880, 2888, 2896, 2904, 2912, 2920, 2928, 2936, 2944, 2952, 2960, 2968, 2976, 2984, 2992, 3000, 3056, 3064, 3072, 3080, 3088, 3096, 3104, 3144, 3168, 3184, 3208, 3216, 3240, 3248, 3256, 3264, 3272, 3280, 3288, 3296, 3304, 3312, 3320, 3328, 3336, 3344, 3352, 3360, 3368, 3376, 3384, 3392, 3400, 3408, 3416, 3424, 3432, 3440, 3448, 3456, 3464, 3472, 3480, 3488, 3496, 3504, 3512, 3520, 3528, 3536, 3544, 3552, 3560, 3568, 3576, 3584, 3592, 3600, 3608, 3616, 3624, 3632, 3640, 3648, 3656, 3664, 3672, 3680, 3688, 3696, 3704, 3712, 3720, 3728, 3736, 3744, 3752, 3760, 3768, 3776, 3784, 3800, 3816, 3824, 3832, 3840, 3848, 3856, 3864, 3872, 3880, 3888, 3896, 3904, 3912, 3920, 3928, 3936, 3944, 3952, 3960, 3968, 3976, 3984, 3992, 4000, 4008, 4072, 4520, 4856, 5384, 5432, 5440, 5448, 5456, 5464, 5472, 5480, 5488, 5496, 5504, 5512, 5520, 5528, 5536, 5544, 5552, 5560, 5568, 5584, 5592, 5600, 5608, 5616, 5624, 5632, 5640, 5648, 5672, 5696, 5720, 5744, 5768, 5792, 5816, 5840, 5864, 5888, 5912, 5936, 5976, 6096, 6744, 6768, 6792, 6816, 6864, 7136, 7160, 7184, 7208, 7248, 7296, 7320, 7368, 7392, 7440, 7464, 7488, 7496, 7512, 7528, 7584, 7600, 7608, 7656, 7680, 7704, 7728, 7752, 7776, 7800, 7824, 7848, 7872, 7896, 7920, 7944, 7968, 7992, 8016, 8040, 8064, 8088, 8104, 8112, 8136, 8144, 8160, 8184, 8208, 8232, 8256, 8280, 8304, 8328, 8352, 8376, 8400, 8424, 8448, 8472, 8496, 8520, 8544, 8568, 8592, 8616, 8640, 8664, 8688, 8712, 8736, 8760, 8784, 8808, 8832, 8856, 8880, 8904, 8928, 8952, 8968, 9000, 9024, 9040, 9072, 9096, 9112, 9144, 9168, 9192, 9240, 9264, 9344, 9360, 9368, 9376, 9384, 9392, 9400, 9408, 9496, 9552, 9576, 9600, 10280, 10288, 10296, 10304, 10312, 10320, 10328, 10336, 10344, 10352, 10360, 10368, 10376, 10384, 10392, 10400, 10408, 10416, 10424, 10432, 10440, 10448, 10456, 10464, 10472, 10480, 10488, 10496, 10504, 10512, 10520, 10528, 10536, 10544, 10552, 10560, 10568, 10576, 10584, 10592, 10600, 10608, 10616, 10624, 10632, 10640, 10648, 10656, 10664, 10672, 10680, 10688, 10696, 10704, 10712, 10720, 10728, 10736, 10744], [7240, 7312, 7384], [2272, 2288, 2304, 2320, 2336], [3008, 3016, 3024, 3032, 3040], [4016, 4024, 4032, 4040], [7192, 7808], [1656, 1704, 1752]], '.text': [[136, 192, 2968, 2976, 2984, 2992, 3000, 3008, 3016, 3024, 3032, 3040, 3048, 3056, 3064], [2712, 2760], [200, 232, 712, 904, 1048, 1288, 2040, 2520], [1888, 1976], [520, 648, 1488], [1096, 2232], [2696, 2744], [1576, 1840]]}
								 }

# Known plaintext fragment profiles
#offset => [(section, plaintext), (section, plaintext),...]
kp_profiles = {}
kp_profiles['rcs_agent'] = {}
kp_profiles['rcs_agent'][0] = [{"section_name": ".text",
			  "plaintext": "\x00\x00\x00\x00\xEB\xFF\xF5\x8B"},
			 {"section_name": ".data",
			  "plaintext": "\x94\x55\x07\x10\x00\x00\x00\x00"}]

kp_profiles['rcs_agent'][0xA0B4] = [{"section_name": ".text",
			  "plaintext": "\x48\x01\x40\x3A\xCB\x75\xF8\x8B"},
			 {"section_name": ".data",
			  "plaintext": "\x75\x81\x86\x75\x76\xC9\x48\x4D"}]

# N-gram statistical profiles
stat_profiles = {}
stat_profiles['rcs_agent'] = {'sections': ['.text', '.data'],
							  'n': 1,
							  'profile': defaultdict(float, {'\x00': 0.09117759146341463, '\x83': 0.022389481707317072, '\x04': 0.030892721036585365, '\x87': 0.000857469512195122, '\x08': 0.018626143292682928, '\x8b': 0.0448266006097561, '\x0c': 0.007860137195121951, '\x8f': 0.0006431021341463415, '\x10': 0.030154344512195123, '\x93': 0.0009527439024390244, '\x14': 0.00721703506097561, '\x97': 0.00035727896341463414, '\x18': 0.005097179878048781, '\x9b': 0.0010003810975609756, '\x1c': 0.004549352134146341, '\x9f': 0.00040491615853658535, ' ': 0.004168254573170732, '\xa3': 0.0012623856707317074, '$': 0.03970560213414634, '\xa7': 0.00030964176829268293, '(': 0.0035727896341463416, '\xab': 0.0008098323170731707, ',': 0.004049161585365854, '\xaf': 0.0010003810975609756, '0': 0.0029058689024390244, '\xb3': 0.001286204268292683, '4': 0.002024580792682927, '\xb7': 0.001286204268292683, '8': 0.003406059451219512, '\xbb': 0.0013338414634146342, '<': 0.0026200457317073172, '\xbf': 0.0010718368902439025, '@': 0.004620807926829268, '\xc3': 0.006812118902439024, 'D': 0.014815167682926829, '\xc7': 0.006812118902439024, 'H': 0.0032393292682926828, '\xcb': 0.0018102134146341464, 'L': 0.0071932164634146345, '\xcf': 0.0007145579268292683, 'P': 0.013219321646341464, '\xd3': 0.0007860137195121952, 'T': 0.005978467987804878, '\xd7': 0.0009765625, 'X': 0.002310403963414634, '\xdb': 0.0015720274390243903, '\\': 0.0035727896341463416, '\xdf': 0.0005478277439024391, '`': 0.0011194740853658536, '\xe3': 0.0005478277439024391, 'd': 0.004454077743902439, '\xe7': 0.001048018292682927, 'h': 0.01112328506097561, '\xeb': 0.0037395198170731706, 'l': 0.0021674923780487807, '\xef': 0.0018102134146341464, 'p': 0.0018340320121951218, '\xf3': 0.0015958460365853658, 't': 0.013671875, '\xf7': 0.0017387576219512195, 'x': 0.0020007621951219513, '\xfb': 0.0018102134146341464, '|': 0.0032631478658536584, '\xff': 0.029939977134146343, '\x80': 0.0028344131097560975, '\x03': 0.005978467987804878, '\x84': 0.006955030487804878, '\x07': 0.003358422256097561, '\x88': 0.002310403963414634, '\x0b': 0.0016196646341463414, '\x8c': 0.0035013338414634147, '\x0f': 0.006526295731707317, '\x90': 0.0014767530487804878, '\x13': 0.0010241996951219513, '\x94': 0.002643864329268293, '\x17': 0.002143673780487805, '\x98': 0.001405297256097561, '\x1b': 0.0009289253048780487, '\x9c': 0.0014529344512195122, '\x1f': 0.0011432926829268292, '\xa0': 0.001214748475609756, '#': 0.0009051067073170732, '\xa4': 0.0014529344512195122, "'": 0.0005716463414634146, '\xa8': 0.0009289253048780487, '+': 0.0026915015243902437, '\xac': 0.0013814786585365853, '/': 0.0005001905487804878, '\xb0': 0.002643864329268293, '3': 0.007836318597560975, '\xb4': 0.0022151295731707315, '7': 0.0005478277439024391, '\xb8': 0.002810594512195122, ';': 0.005740282012195122, '\xbc': 0.0016673018292682926, '?': 0.0010718368902439025, '\xc0': 0.011814024390243903, 'C': 0.0010956554878048782, '\xc4': 0.013957698170731708, 'G': 0.0017863948170731708, '\xc8': 0.0018578506097560975, 'K': 0.0007383765243902439, '\xcc': 0.028201219512195123, 'O': 0.001405297256097561, '\xd0': 0.00624047256097561, 'S': 0.004668445121951219, '\xd4': 0.0010956554878048782, 'W': 0.006169016768292683, '\xd8': 0.001714939024390244, '[': 0.004049161585365854, '\xdc': 0.0014291158536585366, '_': 0.005001905487804878, '\xe0': 0.0013576600609756097, 'c': 0.0005240091463414634, '\xe4': 0.0011671112804878048, 'g': 0.0005478277439024391, '\xe8': 0.01838795731707317, 'k': 0.0008098323170731707, '\xec': 0.003763338414634146, 'o': 0.0009051067073170732, '\xf0': 0.0021913109756097563, 's': 0.001714939024390244, '\xf4': 0.001881669207317073, 'w': 0.0010956554878048782, '\xf8': 0.005811737804878049, '{': 0.0005716463414634146, '\xfc': 0.003048780487804878, '\x7f': 0.001405297256097561, '\x81': 0.0031916920731707315, '\x02': 0.007669588414634146, '\x85': 0.011170922256097561, '\x06': 0.014886623475609756, '\x89': 0.0205078125, '\n': 0.001286204268292683, '\x8d': 0.014600800304878049, '\x0e': 0.0014767530487804878, '\x91': 0.0005954649390243902, '\x12': 0.001048018292682927, '\x95': 0.0008336509146341463, '\x16': 0.0013338414634146342, '\x99': 0.0010718368902439025, '\x1a': 0.0009051067073170732, '\x9d': 0.0007621951219512195, '\x1e': 0.0010241996951219513, '\xa1': 0.0022865853658536584, '"': 0.0006192835365853659, '\xa5': 0.0009051067073170732, '&': 0.0009289253048780487, '\xa9': 0.0005240091463414634, '*': 0.0008098323170731707, '\xad': 0.0006907393292682926, '.': 0.0004763719512195122, '\xb1': 0.0005001905487804878, '2': 0.0009289253048780487, '\xb5': 0.0009289253048780487, '6': 0.0005954649390243902, '\xb9': 0.0013100228658536586, ':': 0.0011194740853658536, '\xbd': 0.0012623856707317074, '>': 0.0010003810975609756, '\xc1': 0.002024580792682927, 'B': 0.0019293064024390244, '\xc5': 0.0010241996951219513, 'F': 0.003120236280487805, '\xc9': 0.0018340320121951218, 'J': 0.000857469512195122, '\xcd': 0.0009051067073170732, 'N': 0.0017625762195121952, '\xd1': 0.0011671112804878048, 'R': 0.005811737804878049, '\xd5': 0.0008098323170731707, 'V': 0.008384146341463415, '\xd9': 0.0005954649390243902, 'Z': 0.0006907393292682926, '\xdd': 0.0005716463414634146, '^': 0.005978467987804878, '\xe1': 0.0006192835365853659, 'b': 0.0005240091463414634, '\xe5': 0.0008098323170731707, 'f': 0.0036442454268292685, '\xe9': 0.0014529344512195122, 'j': 0.008336509146341464, '\xed': 0.001048018292682927, 'n': 0.0006431021341463415, '\xf1': 0.0011909298780487805, 'r': 0.003286966463414634, '\xf5': 0.0010718368902439025, 'v': 0.002096036585365854, '\xf9': 0.0019293064024390244, 'z': 0.0008098323170731707, '\xfd': 0.0012385670731707317, '~': 0.002096036585365854, '\x01': 0.010170541158536585, '\x82': 0.0007621951219512195, '\x05': 0.003358422256097561, '\x86': 0.003930068597560976, '\t': 0.002072217987804878, '\x8a': 0.002143673780487805, '\r': 0.0030964176829268294, '\x8e': 0.0005478277439024391, '\x11': 0.0015005716463414634, '\x92': 0.0005716463414634146, '\x15': 0.005025724085365854, '\x96': 0.00038109756097560977, '\x19': 0.0009051067073170732, '\x9a': 0.0005478277439024391, '\x1d': 0.000857469512195122, '\x9e': 0.0005001905487804878, '!': 0.0005954649390243902, '\xa2': 0.0006431021341463415, '%': 0.0011909298780487805, '\xa6': 0.000428734756097561, ')': 0.0005716463414634146, '\xaa': 0.0005716463414634146, '-': 0.0013576600609756097, '\xae': 0.0005240091463414634, '1': 0.0005954649390243902, '\xb2': 0.0015958460365853658, '5': 0.0012385670731707317, '\xb6': 0.0008098323170731707, '9': 0.001953125, '\xba': 0.0011194740853658536, '=': 0.0017863948170731708, '\xbe': 0.0019293064024390244, 'A': 0.002810594512195122, '\xc2': 0.004120617378048781, 'E': 0.004430259146341463, '\xc6': 0.004358803353658537, 'I': 0.0011671112804878048, '\xca': 0.000857469512195122, 'M': 0.0028820503048780487, '\xce': 0.001524390243902439, 'Q': 0.007574314024390244, '\xd2': 0.0019769435975609756, 'U': 0.004858993902439024, '\xd6': 0.0009289253048780487, 'Y': 0.0013100228658536586, '\xda': 0.0005954649390243902, ']': 0.004763719512195122, '\xde': 0.0007383765243902439, 'a': 0.0006669207317073171, '\xe2': 0.0006907393292682926, 'e': 0.0007621951219512195, '\xe6': 0.0005478277439024391, 'i': 0.0013338414634146342, '\xea': 0.0007860137195121952, 'm': 0.0006907393292682926, '\xee': 0.0009527439024390244, 'q': 0.0004763719512195122, '\xf2': 0.000857469512195122, 'u': 0.009813262195121951, '\xf6': 0.0019769435975609756, 'y': 0.0013338414634146342, '\xfa': 0.001048018292682927, '}': 0.001286204268292683, '\xfe': 0.0025247713414634147}),
							  'error_margin': 1
							 }